## Homebrew LGPL FFMpeg自動更新ワークフローのGitHub Actions実装仕様書

この仕様書は、Homebrewの公式`ffmpeg`フォーミュラの更新をトリガーとして、GitHub Actionsのワークフローを起動し、`ffmpeg-lgpl.rb`を自動更新、ビルド、およびGitHub Releasesへのアップロードを行うプロセスを定義します。

---

### 1. ワークフローのトリガー

このワークフローは、GitHub Actionsのスケジュール機能によって定期的に実行され、Homebrew/homebrew-coreリポジトリの`ffmpeg.rb`が更新されているかを確認します。

* **定期的なチェック**: 毎日などの指定されたスケジュールでワークフローが自動的に実行されます。
* **更新の検知**: ワークフローは、前回実行時以降に`ffmpeg.rb`に変更があったかを検知し、変更があった場合のみ後続のステップに進みます。これにより、不要なビルドを防ぎます。

---

### 2. `ffmpeg-lgpl.rb`の自動作成と更新

`ffmpeg.rb`の更新が検知された場合、LGPL版のフォーミュラを自動で作成・更新します。

* **最新の`ffmpeg.rb`の取得**: Homebrewの`homebrew-core`リポジトリから最新版の`ffmpeg.rb`を自動でコピーします。
* **パッチの適用とファイル名の変更**: コピーしたファイルにLGPL対応のパッチを適用し、ファイル名を`ffmpeg-lgpl.rb`に変更します。
* **`sha256`の空欄化**: ボトルビルド前の段階では、バイナリのハッシュ値は不明なため、`ffmpeg-lgpl.rb`内の`sha256`の行を一時的に空欄に設定します。

---

### 3. ボトルビルドとGitHub Releasesへのアップロード

次に、作成したフォーミュラを使ってバイナリをビルドし、その成果物をGitHub Releasesにアップロードします。

* **ボトルビルドの実行**: GitHub Actions上で、更新された`ffmpeg-lgpl.rb`を使用して`brew bottle`コマンドを実行し、LGPL版のバイナリパッケージ（ボトル）をビルドします。
* **GitHub Releasesへのアップロード**: ビルドで生成されたボトルファイルと、そのメタデータを含むJSONファイルを、GitHubのReleasesにアップロードします。

---

### 4. `sha256`の取得とフォーミュラの更新

ボトルアップロード後、そのハッシュ値をフォーミュラに反映させます。

* **`sha256`の抽出**: `brew bottle`コマンドで生成されたJSONファイルから、`jq`などのツールを使って`sha256`の値を抽出します。
* **`sha256`の書き込み**: 抽出した`sha256`の値を、`ffmpeg-lgpl.rb`ファイルの`sha256 ""`の行に自動的に書き込みます。

---

### 5. リポジトリへの反映とユーザーコマンド

最後に、更新されたフォーミュラをコミットし、リポジトリにプッシュしてプロセスを完了します。

* **Gitコミットとプッシュ**: `sha256`が更新された`ffmpeg-lgpl.rb`をGitでコミットし、リモートリポジトリにプッシュします。
* **ユーザーコマンド**: このワークフローにより、`brew tap lgpl-dev/ffmpeg-lgpl`でこのtapを追加したHomebrewユーザーは、`brew install ffmpeg-lgpl`コマンドでビルド済みのLGPL版を簡単にインストールできるようになります。
